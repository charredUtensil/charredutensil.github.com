<!DOCTYPE html>
<html>
<head>
<title>Bescrabbled</title>
</head>
<body>
<!-- High scoring words:
  EXTERMINATED (252)
  PTERODACTYL (209)
  -->
<style type="text/css">

/* Generated by sass (see game.css.scss for original)*/
html, body {
  position: absolute;
  overflow: hidden;
  left: 0px;
  top: 0px;
  width: 100%;
  height: 100%;
  font-family: Quicksand;
  font-size: 32px;
  text-align: center;
  color: #E7E7E7;
  background-color: #2A4764; }

h1 {
  margin: 10px 0 20px; }

#game {
  margin: auto; }
  #game .grey_div, #game #history div {
    position: relative;
    height: 48px;
    text-align: center; }
    #game .grey_div .text, #game #history div .text {
      line-height: 48px; }
    #game .grey_div .score, #game #history div .score {
      position: absolute;
      font-size: 16px;
      top: 0px; }
  #game .grey_div {
    cursor: pointer;
    color: #1F2022;
    background-color: #E7E7E7;
    background: -moz-gradient(linear, left top, left bottom, from(#e7e7e7), to(#c9c9c9));
    background: -webkit-gradient(linear, left top, left bottom, from(#e7e7e7), to(#c9c9c9));
    border: 3px #5D637C solid;
    border-radius: 10px;
    -o-border-radius: 10px;
    -ms-border-radius: 10px;
    -moz-border-radius: 10px;
    -webkit-border-radius: 10px;
    transition: border-color 4s;
    -o-transition: border-color 4s;
    -ms-transition: border-color 4s;
    -moz-transition: border-color 4s;
    -webkit-transition: border-color 4s; }
    #game .grey_div:hover {
      background: #E7E7E7;
      box-shadow: 10px 6px 12px black;
      z-index: 1; }
    #game .grey_div.selected, #game .grey_div.killm8 {
      color: #C0DBE6;
      background: -moz-gradient(linear, left top, left bottom, from(#75737e), to(#272727));
      background: -webkit-gradient(linear, left top, left bottom, from(#75737e), to(#272727)); }
    #game .grey_div.error {
      border-color: #D30505;
      transition: border-color 0s;
      -o-transition: border-color 0s;
      -ms-transition: border-color 0s;
      -moz-transition: border-color 0s;
      -webkit-transition: border-color 0s; }
  #game #play_area {
    margin: 0;
    width: 100%; }
    #game #play_area .col {
      margin: 0;
      float: left; }
      #game #play_area .col .tile {
        width: 48px; }
        #game #play_area .col .tile .score {
          right: 2px; }
  #game #scores {
    position: relative;
    width: 100%;
    height: 54px; }
    #game #scores #word {
      margin: 0 auto;
      width: 324px; }
    #game #scores .counter {
      position: absolute;
      width: 50%;
      height: 48px;
      line-height: 48px;
      overflow: hidden; }
      #game #scores .counter .tooltip {
        position: relative;
        font-size: 16px;
        bottom: 0px;
        transition: bottom 1s;
        -o-transition: bottom 1s;
        -ms-transition: bottom 1s;
        -moz-transition: bottom 1s;
        -webkit-transition: bottom 1s; }
    #game #scores #timer {
      text-align: left;
      left: 0;
      top: 0; }
    #game #scores #word_count {
      text-align: left;
      left: 0;
      top: 48px; }
    #game #scores #score {
      text-align: right;
      right: 0;
      top: 0; }
    #game #scores #high_score {
      text-align: right;
      right: 0;
      top: 48px; }
  #game #history .item {
    z-index: 2;
    color: #777; }

</style>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script type="text/javascript">
/* Google Web Font code */
WebFontConfig = {
    google: { families: [ 'Quicksand:700:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })(); 
</script>
<script type="text/javascript">
// letters and the frequency they should show up in
$letterBag = "AAAAAAAAABBCCDDDDEEEEEEEEEEEEFFGGGHHIIIIIIIIIJKLLLLMMNNNNNNOOOOOOOOPPQRRRRRRSSSSTTTTTTUUUUVVWWXYYZ   ";

function letterScore(letter) {
  if (letter == ' ') return 0;
  return [1,3,3,2,1,4,2,4,1,8,5,1,3,1,1,3,10,1,1,1,1,4,4,8,4,10][letter.charCodeAt(0)-65];
}

$wordList = ''
$.get('words',function(data){$wordList = data;});

$tileSize = 54;

// store info about game
$score = 0;
$timer = 0;
$wordScore = 0;
$highScore = 0;
$wordCount = 0;
$word = '';
$highWord = '';

// Hide all the things
function initGame() {
  resetBoard(14,8);
  $('#play_area').delegate('.tile','click',tileClick);
  $('#word').click(submitWord);
  $('#game').fadeIn(2000);
  setInterval(updateTimer,1000);
}

function resetBoard(cols,rows) {
  var play_area = $('#play_area');
  play_area.html('').css({'height':rows*$tileSize});
  $('#game').css({'width':cols*$tileSize});
  $score = 0;
  $timer = 0;
  $highScore = 0;
  $wordScore = 0;
  $word = '';
  $highWord = '';
  for (var x=0; x<cols; x++) {
    var col = $("<div class='col'></div>");
    var col_tiles = [];
    play_area.append(col);
    for (var y=0; y<rows; y++) {
      var tile = randomTile();
      col.append(tile);
    }
  }
  updateWord();
  updateScore();
}

function flash(elem) {
  elem.addClass('error');
  setTimeout(function(){elem.removeClass('error');},100);
}

function tileClick() {
  var tile = $(this);
  if (!tile.hasClass('selected') && !tile.hasClass('killm8')) {
    tile.addClass('selected');
    var letter = tile.data('letter');
    $word = $word + letter;
    $wordScore = $wordScore + letterScore(letter);
    updateWord();
  }
}

function connectedGraph() {
  // Oh boy! a graph traversal!
  var unvisited = [];
  var queue = [];
  $('#play_area .col').each(function(x,col) {
    $(col).children('.tile').each(function(y,tile) {
      if ($(tile).hasClass('selected')) unvisited.push(x + ' ' + y);
    });
  });
  if (unvisited.length == 0) return false;
  queue.push(unvisited.pop());
  while (queue.length > 0) {
    var n = queue.shift().split(' ');
    var x = parseInt(n[0]);
    var y = parseInt(n[1]);
    n = unvisited.indexOf((x-1) + ' ' + y);
    if (n != -1) queue.push(unvisited.splice(n,1)[0]);
    n = unvisited.indexOf((x+1) + ' ' + y);
    if (n != -1) queue.push(unvisited.splice(n,1)[0]);
    n = unvisited.indexOf(x + ' ' + (y-1));
    if (n != -1) queue.push(unvisited.splice(n,1)[0]);
    n = unvisited.indexOf(x + ' ' + (y+1));
    if (n != -1) queue.push(unvisited.splice(n,1)[0]);
  }
  // Queue is empty. No unvisited nodes means traversed the whole graph
  return unvisited.length == 0;
}

function validateWord() {
  var re = new RegExp('\\b'+$word.replace(/ /g,'\\w')+'\\b', 'im');
  $word = $wordList.match(re);
  if ($word) {
    $word = $word[0].toUpperCase();
  } else {
    $word = '';
  }
  updateWord();
  return $word.length > 0;
}

function submitWord() {
  var valid = true;
  if (!validateWord()) {
    flash($('#word'));
    valid = false;
  }
  if (!connectedGraph()) {
    flash($('#play_area .selected'));
    valid = false;
  }
  if (valid) {
    $wordScore *= $word.length;
    $score += $wordScore;
    if ($wordScore > $highScore) {
      $highScore = $wordScore;
      $highWord = $word;
    }
    $wordCount += 1;
    updateScore();
    var newTiles = [];
    $('.selected')
      .removeClass('selected')
      .addClass('killm8')
      .each(function(i,e){
        var tile = randomTile().css('display','none');
        newTiles.push(tile[0]);
        $(e).parent().append(tile);
      })
      .slideUp(500,function(){
        $('.killm8').remove();
        $(newTiles).fadeIn(500);
      });
    $('#history')
      .css({'margin-top':-1*$tileSize})
      .animate({'margin-top':0},500)
      .prepend('<div class="item">'+$('#word')[0].innerHTML+'</div>');
  }
  $('.selected').removeClass('selected');
  $word = '';
  $wordScore = 0;
  updateWord();
}

function updateWord() {
  $('#word .text').text($word.replace(/ /g,'?'));
  if ($word.length > 0) {
    $('#word .score').text($wordScore * $word.length);
  } else {
    $('#word .score').text('');
  }
  if ($highWord.length > 0) {
    $('#high_score .tooltip').text($highWord);
  } else {
    $('#high_score .tooltip').text('High Score');
  }
}

function updateScore() {
  $('#score .value').text($score);
  $('#high_score .value').text($highScore);
  $('#word_count .value').text($wordCount);
}

function updateTimer() {
  $timer += 1;
  $('#timer .value').text(Math.floor($timer/60) + ':' + ($timer%60<10 ? '0'+($timer%60) : ($timer%60)));
}

function randomTile() {
  var n = Math.floor(Math.random()*$letterBag.length);
  var letter = $letterBag.substring(n,n+1);
  if (letter == 'Q') letter = 'Qu';
  var elem = $('\
<div class="tile grey_div">\
  <span class="text">' + letter + '</span>\
  <span class="score">' + letterScore(letter) + '</span>\
</div>');
  elem.data('letter', letter);
  //elem.click(tileClick);
  return elem;
}

$(initGame);

</script>
<div id="game_wrapper">
  <h1>Bescrabbled</h1>
  <div id="game" style="display:none;">
    <div id="play_area"></div>
    <div id="scores">
      <div id="score" class="counter">
        <span class="tooltip">
          Total
        </span>
        <span class="value"></span>
      </div>
      <div id="timer" class="counter">
        <span class="value"></span>
      </div>
      <div id="high_score" class="counter">
        <span class="tooltip">
          High Score
        </span>
        <span class="value"></span>
      </div>
      <div id="word_count" class="counter">
        <span class="value"></span>
        <span class="tooltip">
          Words
        </span>
      </div>
      <div id="word" class="grey_div">
        <span class="text"></span><span class="score"></span>
      </div>
    </div>
    <div id="history"></div>
  </div>
</div>

</body></html>
